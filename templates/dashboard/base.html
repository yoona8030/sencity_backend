{% load static %}
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- ✅ 초기 주입된 JWT (없으면 빈 문자열) -->
    <meta name="api-jwt" content="{{ admin_api_token|default:'' }}">
    <!-- ✅ CSRF (토큰 재발급 엔드포인트가 Django view라 필요) -->
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>{% block title %}관리자 페이지{% endblock %}</title>

    <link rel="icon" href="{% static 'dashboard/images/favicon.ico' %}" sizes="any" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}?v=fit-2025-09-19" /> {% block extra_head %}{% endblock %}
</head>

<body>
    {% firstof request.resolver_match.url_name "" as urlname %}
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-brand">관리자 페이지</div>
            <div class="sidebar-logo">
                <img src="{% static 'dashboard/images/logo.png' %}" alt="SENCITY" />
                <span>SENCITY</span>
            </div>
            <a href="{% url 'admin:index' %}" class="sidebar-link">
                <i class="fa-solid fa-arrow-up-right-from-square"></i> 사이트 바로가기
            </a>
            <hr />
            <nav class="sidebar-menu">
                <div class="menu-group">사이트 관리</div>

                <a href="{% url 'dashboard:home' %}" class="menu-item{% if urlname == 'home' %} active{% endif %}">
                    <i class="fa-solid fa-th-large"></i> 대시보드
                </a>

                {% with prefix=urlname|slice:":4" %}
                <a href="{% url 'dashboard:cctv' %}" class="menu-item{% if urlname == 'cctv' or prefix == 'cctv' %} active{% endif %}">
                    <i class="fa-solid fa-camera"></i> CCTV 관리
                </a>
                {% endwith %}

                <a href="{% url 'dashboard:reports' %}" class="menu-item{% if urlname == 'reports' %} active{% endif %}">
                    <i class="fa-solid fa-tv"></i> 신고 처리 및 관리
                </a>

                <a href="{% url 'dashboard:settings' %}" class="menu-item{% if urlname == 'settings' %} active{% endif %}">
                    <i class="fa-solid fa-gear"></i> 설정
                </a>

                <a href="{% url 'dashboard:users' %}" class="menu-item{% if urlname == 'users' %} active{% endif %}">
                    <i class="fa-solid fa-user"></i> 사용자 관리
                </a>

                <div class="menu-group">콘텐츠 및 통계</div>

                <a href="{% url 'dashboard:analytics' %}" class="menu-item{% if urlname == 'analytics' %} active{% endif %}">
                    <i class="fa-solid fa-chart-column"></i> 데이터 분석 및 통계
                </a>

                <a href="{% url 'dashboard:contents' %}" class="menu-item{% if urlname == 'contents' %} active{% endif %}">
                    <i class="fa-solid fa-file-lines"></i> 콘텐츠 관리
                </a>

                <a href="{% url 'dashboard:notices' %}" class="menu-item{% if urlname == 'notices' %} active{% endif %}">
                    <i class="fa-solid fa-bell"></i> 공지 설정
                </a>
            </nav>
        </aside>

        <main class="main-content">{% block content %}{% endblock %} {% block body %}{% endblock %}</main>
    </div>
    <script defer src="{% static 'dashboard/js/tokenManager.js' %}?v=1"></script>
    <script defer src="{% static 'dashboard/js/contents.js' %}?v=1"></script>

    <!-- ✅ axios + JWT 쿠키 기반 인증 설정 -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      // ✅ axios 인스턴스 생성
      const api = axios.create({
        baseURL: "http://localhost:8000/api",
        withCredentials: true,  // 쿠키 자동 전송
      });

      // ✅ csrftoken 쿠키 읽기
      function getCookie(name) {
        const v = document.cookie.split('; ').find(r => r.startsWith(name + '='));
        return v ? decodeURIComponent(v.split('=')[1]) : '';
      }

      // ✅ 모든 요청에 CSRF 헤더 자동 추가
      api.interceptors.request.use(cfg => {
        const csrf = getCookie('csrftoken');
        if (csrf) cfg.headers['X-CSRFToken'] = csrf;
        return cfg;
      });

      // ✅ access 만료 시 자동 재발급 (refresh-cookie)
      api.interceptors.response.use(
        res => res,
        async err => {
          if (err.response?.status === 401) {
            try {
              await api.post('/token/refresh-cookie/');
              return api.request(err.config);
            } catch (e) {
              alert('세션이 만료되었습니다. 다시 로그인해주세요.');
              window.location.href = '/accounts/login/';
            }
          }
          return Promise.reject(err);
        }
      );
    </script>
</body>

</html>
