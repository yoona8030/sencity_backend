{% load static %}
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>관리자 페이지 | 공지 설정</title>

    <link rel="icon" href="{% static 'dashboard/images/favicon.ico' %}" sizes="any" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}?v=fit-2025-09-19" />
    <link rel="stylesheet" href="{% static 'dashboard/css/notices.css' %}?v=2025-09-20" />
</head>

<body class="page-notices">
    <div class="container">
        <!-- 사이드바 -->
        <aside class="sidebar">
            <div class="sidebar-brand">관리자 페이지</div>
            <div class="sidebar-logo">
                <img src="{% static 'dashboard/images/logo.png' %}" alt="SENCITY" />
                <span>SENCITY</span>
            </div>
            <a href="{% url 'admin:index' %}" class="sidebar-link">
                <i class="fa-solid fa-arrow-up-right-from-square"></i> 사이트 바로가기
            </a>
            <hr />
            <nav class="sidebar-menu">
                <div class="menu-group">사이트 관리</div>
                <a href="{% url 'dashboard:home' %}" class="menu-item">
                    <i class="fa-solid fa-th-large"></i> 대시보드
                </a>
                <a href="{% url 'dashboard:cctv' %}" class="menu-item">
                    <i class="fa-solid fa-camera"></i> CCTV 관리
                </a>
                <a href="{% url 'dashboard:reports' %}" class="menu-item">
                    <i class="fa-solid fa-tv"></i> 신고 처리 및 관리
                </a>
                <a href="{% url 'dashboard:settings' %}" class="menu-item">
                    <i class="fa-solid fa-gear"></i> 설정
                </a>
                <a href="{% url 'dashboard:users' %}" class="menu-item">
                    <i class="fa-solid fa-user"></i> 사용자 관리
                </a>

                <div class="menu-group">콘텐츠 및 통계</div>
                <a href="{% url 'dashboard:analytics' %}" class="menu-item">
                    <i class="fa-solid fa-chart-column"></i> 데이터 분석 및 통계
                </a>
                <a href="{% url 'dashboard:contents' %}" class="menu-item">
                    <i class="fa-solid fa-file-lines"></i> 콘텐츠 관리
                </a>
                <a href="{% url 'dashboard:notices' %}" class="menu-item active">
                    <i class="fa-solid fa-bell"></i> 공지 설정
                </a>
            </nav>
        </aside>

        <!-- 본문 -->
        <main class="main">
            <div class="main-content">
                <div class="dashboard-body wrap">
                    <h1 class="page-title">공지 설정</h1>

                    <section class="page-card">
                        <!-- 툴바 -->
                        <div class="section-header">
                            <div class="section-actions-left">
                                <button type="button" class="btn primary">＋ 새 공지</button>
                                <select id="scope" class="input select">
                    <option value="">전체</option>
                    <option value="global">그룹</option>
                    <option value="personal">개인</option>
                  </select>
                            </div>

                            <div class="section-actions-right">
                                <div class="search-wrap">
                                    <input id="q" class="input" placeholder="유형/상태 변경 내용 검색" />
                                    <button id="search" class="btn">검색</button>
                                </div>
                            </div>
                        </div>

                        <!-- 표 -->
                        <div class="table-scroll">
                            <table class="table" id="notice-table">
                                <thead>
                                    <tr>
                                        <th style="width: 7ch">ID</th>
                                        <th>제목</th>
                                        <th style="width: 12ch">대상</th>
                                        <th style="width: 14ch">유형</th>
                                        <th style="width: 20ch">생성 시각</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody">
                                    {% if notices %}{% for n in notices %}
                                    <tr data-id="{{ n.id }}" data-type="{{ n.type|default:'' }}">
                                        <td class="id-cell">{{ n.id }}</td>
                                        <td class="title-cell" role="button" tabindex="0">{{ n.title_suggest|default:n.title }}</td>
                                        <td>{{ n.scope }}</td>
                                        <td>{{ n.type }}</td>
                                        <td>{{ n.created_at }}</td>
                                    </tr>
                                    {% endfor %}{% else %}
                                    <tr>
                                        <td colspan="5" class="empty">표시할 공지가 없습니다</td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <script>
        var API = '/dashboard/api/notices/';

        var els = {
            tbody: function() {
                return document.getElementById('tbody');
            },
            scope: function() {
                return document.getElementById('scope');
            },
            q: function() {
                return document.getElementById('q');
            },
            btn: function() {
                return document.getElementById('search');
            },
        };

        function escapeHtml(s) {
            s = String(s == null ? '' : s);
            return s.replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;',
                }[m];
            });
        }

        function nl2br(s) {
            return escapeHtml(s || '').replace(/\n/g, '<br>');
        }

        function detailRow(id, html) {
            var tr = document.createElement('tr');
            tr.className = 'detail-row';
            tr.setAttribute('data-for', id);
            tr.innerHTML = '<td class="detail-cell" colspan="5"><div class="detail-box">' + html + '</div></td>';
            return tr;
        }

        function closeDetail(id) {
            var d = els.tbody().querySelector('tr.detail-row[data-for="' + id + '"]');
            if (d) d.remove();
        }

        async function openDetail(id, afterTr) {
            var opened = els.tbody().querySelector('tr.detail-row[data-for="' + id + '"]');
            if (opened) {
                closeDetail(id);
                return;
            }

            var loading = detailRow(id, '<div class="detail-loading">불러오는 중…</div>');
            afterTr.insertAdjacentElement('afterend', loading);

            try {
                var url = new URL(API, window.location.origin);
                url.searchParams.set('id', id);
                var r = await fetch(url.toString(), {
                    credentials: 'same-origin',
                });
                if (!r.ok) throw new Error('load failed');
                var data = await r.json();
                var n = data.notice || {};
                var content = String(n.content || '').trim();

                // 본문
                loading.querySelector('.detail-box').innerHTML = content ? nl2br(content) : '내용이 없습니다';

                // 제목 셀 갱신(백엔드가 내려준 title_suggest 우선)
                var row = els.tbody().querySelector('tr[data-id="' + id + '"]');
                if (row) {
                    var cell = row.querySelector('.title-cell');
                    if (cell) {
                        var t = String(n.title_suggest || n.title || '').trim();
                        cell.textContent = t || '공지';
                    }
                }
            } catch (e) {
                loading.querySelector('.detail-box').innerHTML = '<div class="detail-error">불러오기에 실패했습니다.</div>';
            }
        }

        async function loadList(page) {
            page = page || 1;
            var url = new URL(API, window.location.origin);
            url.searchParams.set('page', page);
            url.searchParams.set('page_size', 20);

            var sc = els.scope().value;
            var q = (els.q().value || '').trim();

            // 필터: scope=global|personal 사용
            if (sc === 'global') url.searchParams.set('scope', 'global');
            else if (sc === 'personal') url.searchParams.set('scope', 'personal');

            if (q) url.searchParams.set('q', q);

            els.tbody().innerHTML = '<tr><td colspan="5" class="empty">불러오는 중…</td></tr>';

            try {
                var r = await fetch(url.toString(), {
                    credentials: 'same-origin',
                });
                if (!r.ok) throw new Error('list failed');
                var d = await r.json();
                var html = '';
                var arr = d.results || [];
                for (var i = 0; i < arr.length; i++) {
                    var n = arr[i];
                    var safeTitle = escapeHtml(n.title_suggest || n.title || '');

                    html +=
                        '<tr data-id="' +
                        n.id +
                        '" data-type="' +
                        (n.type || '') +
                        '">' +
                        '<td class="id-cell">' +
                        n.id +
                        '</td>' +
                        '<td class="title-cell" role="button" tabindex="0">' +
                        safeTitle +
                        '</td>' +
                        '<td>' +
                        escapeHtml(n.scope || '') +
                        '</td>' +
                        '<td>' +
                        escapeHtml(n.type || '') +
                        '</td>' +
                        '<td>' +
                        escapeHtml(n.created_at || '') +
                        '</td>' +
                        '</tr>';
                }
                els.tbody().innerHTML = html || '<tr><td colspan="5" class="empty">표시할 공지가 없습니다</td></tr>';
            } catch (e) {
                els.tbody().innerHTML = '<tr><td colspan="5" class="empty error">불러오기에 실패했습니다</td></tr>';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // 제목 클릭으로 상세 토글
            els.tbody().addEventListener('click', function(e) {
                var cell = e.target.closest('td.title-cell');
                if (!cell) return;
                var tr = cell.closest('tr');
                var id = tr && tr.getAttribute('data-id');
                if (!id) return;
                openDetail(id, tr);
            });
            // 키보드 접근성(Enter/Space)
            els.tbody().addEventListener('keydown', function(e) {
                var cell = e.target.closest('td.title-cell');
                if (!cell) return;
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    var tr = cell.closest('tr');
                    var id = tr && tr.getAttribute('data-id');
                    if (!id) return;
                    openDetail(id, tr);
                }
            });

            els.btn().addEventListener('click', function() {
                loadList(1);
            });
            els.scope().addEventListener('change', function() {
                loadList(1);
            });

            var timer = null;
            els.q().addEventListener('input', function() {
                clearTimeout(timer);
                timer = setTimeout(function() {
                    loadList(1);
                }, 300);
            });

            // 첫 로드: SSR 그대로 볼거면 주석 유지
            // loadList(1);
        });
    </script>
</body>

</html>
