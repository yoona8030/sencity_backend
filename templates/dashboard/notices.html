{% load static %}
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="csrf-token" content="{{ csrf_token }}" />
    <meta name="api-jwt" content="{{ initial_jwt|default:'' }}" />

    <!-- í† í°/í‘¸ì‹œ ìœ í‹¸ -->
    <script src="{% static 'dashboard/token.js' %}?v=2025-10-01-1"></script>
    <script src="{% static 'dashboard/push.js' %}?v=2025-10-01-1"></script>
    <script src="{% static 'dashboard/js/contents.js' %}?v=2025-10-01-1"></script>

    <title>ê´€ë¦¬ì í˜ì´ì§€ | ê³µì§€ ì„¤ì •</title>

    <link rel="icon" href="{% static 'dashboard/images/favicon.ico' %}" sizes="any" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}?v=fit-2025-09-19" />
    <link rel="stylesheet" href="{% static 'dashboard/css/notices.css' %}?v=2025-10-25-paging-2" />
  </head>

  <body class="page-notices">
    <div class="container">
      <!-- ì‚¬ì´ë“œë°” -->
      <aside class="sidebar">
        <div class="sidebar-brand">ê´€ë¦¬ì í˜ì´ì§€</div>
        <div class="sidebar-logo">
          <img src="{% static 'dashboard/images/logo.png' %}" alt="SENCITY" />
          <span>SENCITY</span>
        </div>
        <a href="{% url 'admin:index' %}" class="sidebar-link">
          <i class="fa-solid fa-arrow-up-right-from-square"></i>
          ì‚¬ì´íŠ¸ ë°”ë¡œê°€ê¸°
        </a>
        <hr />
        <nav class="sidebar-menu">
          <div class="menu-group">ì‚¬ì´íŠ¸ ê´€ë¦¬</div>
          <a href="{% url 'dashboard:home' %}" class="menu-item">
            <i class="fa-solid fa-th-large"></i>
            ëŒ€ì‹œë³´ë“œ
          </a>
          <a href="{% url 'dashboard:cctv' %}" class="menu-item">
            <i class="fa-solid fa-camera"></i>
            CCTV ê´€ë¦¬
          </a>
          <a href="{% url 'dashboard:reports' %}" class="menu-item">
            <i class="fa-solid fa-tv"></i>
            ì‹ ê³  ì²˜ë¦¬ ë° ê´€ë¦¬
          </a>
          <a href="{% url 'dashboard:settings' %}" class="menu-item">
            <i class="fa-solid fa-gear"></i>
            ì„¤ì •
          </a>
          <a href="{% url 'dashboard:users' %}" class="menu-item">
            <i class="fa-solid fa-user"></i>
            ì‚¬ìš©ì ê´€ë¦¬
          </a>

          <div class="menu-group">ì½˜í…ì¸  ë° í†µê³„</div>
          <a href="{% url 'dashboard:analytics' %}" class="menu-item">
            <i class="fa-solid fa-chart-column"></i>
            ë°ì´í„° ë¶„ì„ ë° í†µê³„
          </a>
          <a href="{% url 'dashboard:contents' %}" class="menu-item">
            <i class="fa-solid fa-file-lines"></i>
            ì½˜í…ì¸  ê´€ë¦¬
          </a>
          <a href="{% url 'dashboard:notices' %}" class="menu-item active">
            <i class="fa-solid fa-bell"></i>
            ê³µì§€ ì„¤ì •
          </a>
        </nav>
      </aside>

      <!-- ë³¸ë¬¸ -->
      <main class="main">
        <div class="main-content">
          <div class="dashboard-body wrap">
            <h1 class="page-title">ê³µì§€ ì„¤ì •</h1>

            <section class="page-card">
              <!-- íˆ´ë°” -->
              <div class="section-header">
                <div class="section-actions-left">
                  <button type="button" class="btn primary" id="btn-refresh">â†» ìƒˆë¡œê³ ì¹¨</button>

                  <select id="scope" class="input select" title="ë²”ìœ„">
                    <option value="">ì „ì²´</option>
                    <option value="global">ê·¸ë£¹</option>
                    <option value="personal">ê°œì¸</option>
                  </select>
                </div>

                <div class="section-actions-right">
                  <div class="search-wrap">
                    <input id="q" class="input" placeholder="ì œëª©/ë³¸ë¬¸ ê²€ìƒ‰(ê·¸ë£¹ ê³µì§€ ìœ„ì£¼)" />
                    <button id="search" class="btn">ê²€ìƒ‰</button>
                  </div>

                  <button id="btn-push-open" class="btn danger" title="ì„ íƒ ê³µì§€ë¥¼ í‘¸ì‹œë¡œ ë°œì†¡">
                    <i class="fa-solid fa-paper-plane"></i>
                    ì„ íƒ ê³µì§€ í‘¸ì‹œ ì „ì†¡
                  </button>
                </div>
              </div>

              <!-- í‘œ -->
              <div class="table-scroll">
                <table class="table" id="notice-table">
                  <thead>
                    <tr>
                      <th style="width: 7ch">ID</th>
                      <th>ì œëª©</th>
                      <th style="width: 12ch">ëŒ€ìƒ</th>
                      <th style="width: 14ch">ìœ í˜•</th>
                      <th style="width: 20ch">ìƒì„± ì‹œê°</th>
                    </tr>
                  </thead>
                  <tbody id="tbody">
                    <!-- JS ë¡œë“œ -->
                  </tbody>
                </table>
              </div>

              <!-- âœ… í˜ì´ì§€ë„¤ì´ì…˜ -->
              <div id="pagination" class="pagination"></div>
            </section>
          </div>
        </div>
      </main>
    </div>

    <!-- í‘¸ì‹œ ì „ì†¡ ëª¨ë‹¬ -->
    <div id="pushModal" class="modal" tabindex="-1" aria-labelledby="pushModalTitle" aria-hidden="true" hidden>
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="pushModalTitle" class="modal-title">ì„ íƒ ê³µì§€ í‘¸ì‹œ ì „ì†¡</h5>
            <button type="button" class="btn close" id="pm-close" aria-label="ë‹«ê¸°">Ã—</button>
          </div>

          <div class="modal-body">
            <div>
              <label class="text-muted">ì œëª©</label>
              <input id="pm-title" class="input" maxlength="80" />
            </div>
            <div>
              <label class="text-muted">ë³¸ë¬¸</label>
              <textarea id="pm-body" rows="6" class="input"></textarea>
              <div class="text-muted">â€» ì•±ì´ ì¢…ë£Œ ìƒíƒœì—¬ë„ ë³´ì´ê²Œ í•˜ë ¤ë©´ ì œëª©/ë³¸ë¬¸ì´ ìˆëŠ” notification ì „ì†¡ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>
            </div>
            <details>
              <summary>ëŒ€ìƒ ì˜µì…˜ (ê¸°ë³¸: ì „ì²´)</summary>
              <div style="display: grid; gap: 6px; margin-top: 6px">
                <label class="text-muted">íŠ¹ì • ì‚¬ìš©ì ID ì‰¼í‘œë¡œ ì…ë ¥ (ì˜ˆ: 12,34,56)</label>
                <input id="pm-userids" class="input" placeholder="ë¹„ìš°ë©´ ì „ì²´ ë°œì†¡" />
              </div>
            </details>
          </div>

          <div class="modal-footer">
            <button id="pm-cancel" class="btn secondary" type="button">ì·¨ì†Œ</button>
            <button id="pm-send" class="btn danger" type="button">
              <i class="fa-solid fa-paper-plane"></i>
              ì „ì†¡
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ====== ìƒìˆ˜/ê²½ë¡œ ======
      const API_BASE = '/api/notifications/'; // ëª©ë¡/ìƒì„¸
      const PUSH_GROUP_API = '/api/push/broadcast/'; // ê³µì§€ ì „ì†¡ API (ë ìŠ¬ë˜ì‹œ)

      const PAGE_SIZE = 20;

      // ====== ì—˜ë¦¬ë¨¼íŠ¸ ======
      const els = {
        tbody: () => document.getElementById('tbody'),
        scope: () => document.getElementById('scope'),
        q: () => document.getElementById('q'),
        btnSearch: () => document.getElementById('search'),
        btnRefresh: () => document.getElementById('btn-refresh'),
        btnPushOpen: () => document.getElementById('btn-push-open'),
        modal: () => document.getElementById('pushModal'),
        pmTitle: () => document.getElementById('pm-title'),
        pmBody: () => document.getElementById('pm-body'),
        pmUserIds: () => document.getElementById('pm-userids'),
        pmCancel: () => document.getElementById('pm-cancel'),
        pmSend: () => document.getElementById('pm-send'),
      };

      // ====== ìœ í‹¸ ======
      function escapeHtml(s) {
        s = String(s == null ? '' : s);
        return s.replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
      }
      function nl2br(s) {
        return escapeHtml(s || '').replace(/\n/g, '<br>');
      }

      function detailRow(id, html) {
        const tr = document.createElement('tr');
        tr.className = 'detail-row';
        tr.dataset.for = id;
        tr.innerHTML = '<td class="detail-cell" colspan="5"><div class="detail-box">' + html + '</div></td>';
        return tr;
      }
      function closeDetail(id) {
        els
          .tbody()
          .querySelectorAll(`tr.detail-row[data-for="${id}"]`)
          .forEach((n) => n.remove());
      }
      function clearSelected() {
        els
          .tbody()
          .querySelectorAll('tr.selected')
          .forEach((tr) => tr.classList.remove('selected'));
      }
      function selectRow(tr) {
        clearSelected();
        tr.classList.add('selected');
      }

      function scopeToType(scopeVal) {
        // '' â†’ group(ê¸°ë³¸), personal â†’ individual
        if (scopeVal === 'personal') return 'individual';
        return 'group';
      }
      function ensureModalHidden() {
        const m = els.modal();
        if (!m) return;
        m.setAttribute('hidden', ''); // HTML hidden ì†ì„±
        m.setAttribute('aria-hidden', 'true');
        m.style.display = 'none'; // ì•ˆì „ì¥ì¹˜ë¡œ display: none
      }
      // ====== ìƒì„¸ ì—´ê¸° ======
      async function openDetail(id, afterTr) {
        const opened = els.tbody().querySelector(`tr.detail-row[data-for="${id}"]`);
        if (opened) {
          closeDetail(id);
          return;
        }

        const loading = detailRow(id, '<div class="detail-loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>');
        afterTr.insertAdjacentElement('afterend', loading);

        try {
          const url = API_BASE + id + '/';
          const r = await (window.AdminToken?.authFetch
            ? window.AdminToken.authFetch(url, { method: 'GET' })
            : fetch(url, { credentials: 'same-origin' }));
          if (!r.ok) throw new Error('load failed');
          const n = await r.json();
          const content = String(n.message || n.reply || '').trim();
          loading.querySelector('.detail-box').innerHTML = content ? nl2br(content) : 'ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤';

          const cell = els.tbody().querySelector(`tr[data-id="${id}"] .title-cell`);
          if (cell) cell.textContent = (n.title || 'ê³µì§€').trim();
        } catch (e) {
          loading.querySelector('.detail-box').innerHTML = '<div class="detail-error">ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
        }
      }

      // ====== ëª©ë¡ ë¡œë“œ + í˜ì´ì§€ë„¤ì´ì…˜ ======
      async function loadList(page = 1) {
        const url = new URL(API_BASE, location.origin);

        // íƒ€ì… í•„í„°
        const sc = els.scope().value; // '', 'global', 'personal'
        const type = scopeToType(sc);
        url.searchParams.set('type', type);

        // í˜ì´ì§€
        url.searchParams.set('page', page);
        url.searchParams.set('page_size', PAGE_SIZE);

        // ê²€ìƒ‰ì–´(í´ë¼ì´ì–¸íŠ¸ í•„í„°)
        const q = (els.q().value || '').trim();

        els.tbody().innerHTML = '<tr><td colspan="5" class="empty">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td></tr>';

        try {
          const r = await (window.AdminToken?.authFetch
            ? window.AdminToken.authFetch(url.toString(), { method: 'GET' })
            : fetch(url.toString(), { credentials: 'same-origin' }));
          if (!r.ok) throw new Error('list failed');

          const d = await r.json(); // DRF ê¸°ë³¸: {count, next, previous, results: [...]}

          const rows = (d.results || d || []).filter((n) => {
            if (!q) return true;
            const text = (n.title || '') + '\n' + (n.reply || n.message || '');
            return text.toLowerCase().includes(q.toLowerCase());
          });

          let html = '';
          rows.forEach((n) => {
            const id = n.notification_id ?? n.id;
            const targetLabel = n.type === 'group' ? 'ì „ì²´' : 'ê°œì¸';
            const typeLabel = n.status_label || n.type || '';
            const created = (n.created_at || '').toString();
            const safeTitle = escapeHtml(n.title || '');

            html += `
              <tr data-id="${id}" data-type="${escapeHtml(n.type || '')}">
                <td class="id-cell">${id}</td>
                <td class="title-cell" role="button" tabindex="0">${safeTitle}</td>
                <td>${targetLabel}</td>
                <td>${escapeHtml(typeLabel)}</td>
                <td>${escapeHtml(created)}</td>
              </tr>`;
          });

          els.tbody().innerHTML = html || '<tr><td colspan="5" class="empty">í‘œì‹œí•  ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';

          // âœ… í˜ì´ì§€ë„¤ì´ì…˜
          const total = Number(d.count ?? 0);
          const totalPages = total > 0 ? Math.ceil(total / PAGE_SIZE) : 1;
          renderPagination(page, totalPages);
        } catch (e) {
          console.error(e);
          els.tbody().innerHTML = '<tr><td colspan="5" class="empty error">ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</td></tr>';
          renderPagination(1, 1);
        }
      }

      function renderPagination(page, totalPages) {
        const pag = document.getElementById('pagination');
        if (!pag) return;
        pag.innerHTML = '';

        if (totalPages <= 1) return;

        const makeBtn = (num, text = String(num), active = false, disabled = false) => {
          const b = document.createElement('button');
          b.textContent = text;
          b.type = 'button';
          b.className = 'page-btn' + (active ? ' active' : '');
          if (!disabled) {
            b.addEventListener('click', () => loadList(num));
          } else {
            b.disabled = true;
          }
          return b;
        };

        // ì²˜ìŒ/ì´ì „
        pag.appendChild(makeBtn(1, 'Â«', false, page === 1));
        pag.appendChild(makeBtn(Math.max(1, page - 1), 'â†', false, page === 1));

        // ìˆ«ì ë²„íŠ¼ (ìµœëŒ€ 5ê°œ)
        const start = Math.max(1, page - 2);
        const end = Math.min(totalPages, page + 2);
        for (let i = start; i <= end; i++) {
          pag.appendChild(makeBtn(i, String(i), i === page));
        }

        // ë‹¤ìŒ/ë
        pag.appendChild(makeBtn(Math.min(totalPages, page + 1), 'â†’', false, page === totalPages));
        pag.appendChild(makeBtn(totalPages, 'Â»', false, page === totalPages));
      }

      // ====== ëª¨ë‹¬ ======
      let _lastFocus = null;

      function openPushModal(prefill) {
        const modal = els.modal();

        // âœ… í˜¹ì‹œ ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆ ì•ˆì— ìˆìœ¼ë©´ bodyë¡œ ì´ë™í•´ viewport ê¸°ì¤€ ë³´ì¥
        if (modal.parentElement !== document.body) {
          document.body.appendChild(modal);
        }

        els.pmTitle().value = prefill.title || 'ê³µì§€';
        els.pmBody().value = (prefill.body || '').trim();
        els.pmUserIds().value = '';

        _lastFocus = document.activeElement;

        // âœ… ìŠ¤í¬ë¡¤ ì ê¸ˆ
        document.body.classList.add('no-scroll');

        // í‘œì‹œ
        modal.removeAttribute('hidden');
        modal.setAttribute('aria-hidden', 'false');

        // flex ì¤‘ì•™ ì •ë ¬ ìœ ì§€
        modal.style.display = 'flex';

        // ì²« í¬ì»¤ìŠ¤
        requestAnimationFrame(() => {
          els.pmTitle().focus();
        });
      }

      function closePushModal() {
        const modal = els.modal();
        modal.setAttribute('aria-hidden', 'true');
        modal.style.display = 'none';
        modal.setAttribute('hidden', '');

        // âœ… ìŠ¤í¬ë¡¤ ì ê¸ˆ í•´ì œ
        document.body.classList.remove('no-scroll');

        // íŠ¸ë¦¬ê±°ë¡œ í¬ì»¤ìŠ¤ ë³µê·€
        if (_lastFocus && typeof _lastFocus.focus === 'function') {
          _lastFocus.focus();
        } else {
          els.btnPushOpen().focus();
        }
      }
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && els.modal().getAttribute('aria-hidden') === 'false') closePushModal();
      });
      els.modal().addEventListener('click', (e) => {
        if (e.target === els.modal()) closePushModal();
      });
      document.getElementById('pm-close')?.addEventListener('click', closePushModal);

      // ê³µì§€ ì „ì†¡(ê·¸ë£¹/ê°œì¸)
      async function sendBroadcastPush(payload) {
        if (window.AdminToken?.authFetch) {
          const res = await window.AdminToken.authFetch(PUSH_GROUP_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}: ` + (await res.text()).slice(0, 300));
          return res.json();
        }
        // ì„¸ì…˜ + CSRF
        function getCookie(name) {
          let v = null;
          (document.cookie || '')
            .split(';')
            .map((s) => s.trim())
            .forEach((c) => {
              if (c.startsWith(name + '=')) v = decodeURIComponent(c.slice(name.length + 1));
            });
          return v;
        }
        const csrftoken = getCookie('csrftoken');
        const res = await fetch(PUSH_GROUP_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
          credentials: 'same-origin',
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}: ` + (await res.text()).slice(0, 300));
        return res.json();
      }

      // ====== ì´ˆê¸° ë°”ì¸ë”© ======
      document.addEventListener('DOMContentLoaded', function () {
        ensureModalHidden();
        // í‘œ í–‰ í´ë¦­/í‚¤ë³´ë“œ ì—´ê¸°
        els.tbody().addEventListener('click', function (e) {
          const tr = e.target.closest('tr');
          if (!tr) return;
          selectRow(tr);
          const id = tr.getAttribute('data-id');
          if (id) openDetail(id, tr);
        });
        els.tbody().addEventListener('keydown', function (e) {
          const cell = e.target.closest('td.title-cell');
          if (!cell) return;
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            const tr = cell.closest('tr');
            if (!tr) return;
            selectRow(tr);
            const id = tr.getAttribute('data-id');
            if (id) openDetail(id, tr);
          }
        });

        // ê²€ìƒ‰/í•„í„°/ìƒˆë¡œê³ ì¹¨
        els.btnSearch().addEventListener('click', () => loadList(1));
        els.btnRefresh().addEventListener('click', () => loadList(1));
        els.scope().addEventListener('change', () => loadList(1));
        let timer = null;
        els.q().addEventListener('input', function () {
          clearTimeout(timer);
          timer = setTimeout(() => loadList(1), 300);
        });

        // í‘¸ì‹œ ëª¨ë‹¬ ì—´ê¸°
        els.btnPushOpen().addEventListener('click', async function () {
          const tr = els.tbody().querySelector('tr.selected');
          if (!tr) {
            alert('í‘¸ì‹œë¡œ ë³´ë‚¼ ê³µì§€ë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”. (í–‰ì„ í´ë¦­)');
            return;
          }
          const id = tr.getAttribute('data-id');

          // í”„ë¦¬í•„
          let title = (tr.querySelector('.title-cell')?.textContent || 'ê³µì§€').trim();
          let body = '';
          try {
            const url = API_BASE + id + '/';
            const r = await (window.AdminToken?.authFetch
              ? window.AdminToken.authFetch(url, { method: 'GET' })
              : fetch(url, { credentials: 'same-origin' }));
            if (r.ok) {
              const n = await r.json();
              title = (n.title || title).trim();
              body = (n.reply || n.message || '').trim();
            }
          } catch (_) {}
          openPushModal({ title, body });
        });

        // ëª¨ë‹¬ ë²„íŠ¼
        els.pmCancel().addEventListener('click', closePushModal);
        els.pmSend().addEventListener('click', async function () {
          const sel = els.tbody().querySelector('tr.selected');
          if (!sel) {
            alert('í‘¸ì‹œë¡œ ë³´ë‚¼ ê³µì§€ë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.');
            return;
          }

          const title = String(els.pmTitle().value || '').trim();
          const body = String(els.pmBody().value || '').trim();
          const users = String(els.pmUserIds().value || '').trim();

          // ìµœì†Œ í•œ ê°œëŠ” í•„ìš”(ë°±ì—”ë“œ ê²€ì¦ê³¼ ì¼ì¹˜)
          if (!title && !body) {
            alert('ì œëª© ë˜ëŠ” ë³¸ë¬¸ ì¤‘ í•˜ë‚˜ëŠ” í•„ìš”í•©ë‹ˆë‹¤.');
            return;
          }

          let user_ids = null;
          if (users) {
            user_ids = users
              .split(',')
              .map((x) => parseInt(x.trim(), 10))
              .filter((n) => !isNaN(n));
            if (user_ids.length === 0) user_ids = null;
          }

          try {
            // ğŸ”´ í•µì‹¬: title/body í‚¤ë¡œ ë³´ëƒ„ + data.kind=notice (ì•±ì—ì„œ ë¶„ê¸°ìš©)
            const res = await sendBroadcastPush({
              title: title, // âœ…
              body: body, // âœ…
              data: { kind: 'notice' },
              user_ids: user_ids || undefined, // ì—†ìœ¼ë©´ ì „ì²´
            });

            alert('í‘¸ì‹œ ì „ì†¡ ì™„ë£Œ\nsuccess=' + (res.success ?? 0) + ', failure=' + (res.failure ?? 0));
            closePushModal();
          } catch (e) {
            console.error(e);
            alert('í‘¸ì‹œ ì „ì†¡ ì‹¤íŒ¨: ' + e.message);
          }
        });

        // ì²« ë¡œë“œ
        loadList(1);
      });
    </script>
  </body>
</html>
