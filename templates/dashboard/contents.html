{% load static %}
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>관리자 페이지 | 콘텐츠 템플릿</title>

    <!-- 공통 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}?v=fit-2025-09-19" />

    <!-- 이 페이지 전용 -->
    <link rel="stylesheet" href="{% static 'dashboard/css/contents.css' %}?v=16" />
</head>

<body class="page-contents">
    <div class="container">
        <!-- 사이드바 -->
        <aside class="sidebar">
            <div class="sidebar-brand">관리자 페이지</div>
            <div class="sidebar-logo">
                <img src="{% static 'dashboard/images/logo.png' %}" alt="SENCITY" />
                <span>SENCITY</span>
            </div>
            <a href="{% url 'admin:index' %}" class="sidebar-link">
                <i class="fa-solid fa-arrow-up-right-from-square"></i> 사이트 바로가기
            </a>
            <hr />
            <nav class="sidebar-menu">
                <div class="menu-group">사이트 관리</div>
                <a href="{% url 'dashboard:home' %}" class="menu-item">
                    <i class="fa-solid fa-th-large"></i> 대시보드
                </a>
                <a href="{% url 'dashboard:cctv' %}" class="menu-item">
                    <i class="fa-solid fa-camera"></i> CCTV 관리
                </a>
                <a href="{% url 'dashboard:reports' %}" class="menu-item">
                    <i class="fa-solid fa-tv"></i> 신고 처리 및 관리
                </a>
                <a href="{% url 'dashboard:settings' %}" class="menu-item">
                    <i class="fa-solid fa-gear"></i> 설정
                </a>
                <a href="{% url 'dashboard:users' %}" class="menu-item">
                    <i class="fa-solid fa-user"></i> 사용자 관리
                </a>

                <div class="menu-group">콘텐츠 및 통계</div>
                <a href="{% url 'dashboard:analytics' %}" class="menu-item">
                    <i class="fa-solid fa-chart-column"></i> 데이터 분석 및 통계
                </a>
                <a href="{% url 'dashboard:contents' %}" class="menu-item active">
                    <i class="fa-solid fa-file-lines"></i> 콘텐츠 템플릿
                </a>
                <a href="{% url 'dashboard:notices' %}" class="menu-item">
                    <i class="fa-solid fa-bell"></i> 공지 설정
                </a>
            </nav>
        </aside>

        <!-- 본문 -->
        <main class="main-content" id="main">
            <div class="dashboard-body wrap">
                <!-- 타이틀 -->
                <h1 class="page-title">콘텐츠 템플릿</h1>

                <!-- 툴바 -->
                <section class="card page-card">
                    <div class="section-header">
                        <!-- 좌측: 검색 -->
                        <div class="section-actions-left">
                            <input id="q" class="input" type="text" placeholder="제목/태그 검색" />
                            <button id="btn-search" class="btn">
                <i class="fa-solid fa-magnifying-glass"></i>
                검색
              </button>
                        </div>

                        <!-- 우측: 액션 -->
                        <div class="section-actions-right">
                            <select id="templateSelect" class="input select">
                <option value="">템플릿 선택</option>
                <option value="new-card">신규 기능 카드</option>
                <option value="weekly">주간 통계 하이라이트</option>
                <option value="safety">안전 수칙 카드</option>
                <option value="event">이벤트 안내</option>
                <option value="app-banner">앱 배너 공지</option>
              </select>
                            <button id="btn-add-template" class="btn ghost">
                <i class="fa-regular fa-square-plus"></i>
                템플릿 추가
              </button>
                            <button id="btn-new" class="btn primary">
                <i class="fa-solid fa-plus"></i>
                새 콘텐츠
              </button>
                        </div>
                    </div>

                    <!-- 섹션: 추천 템플릿 -->
                    <h2 class="sec-title">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> 추천 템플릿
                    </h2>
                    <div class="template-grid">
                        <!-- 신규 기능 카드 -->
                        <article class="tmpl-card" data-template-id="new-card">
                            <div class="tmpl-head">
                                <div class="tmpl-icon"><i class="fa-solid fa-star-of-life"></i></div>
                                <div class="tmpl-title">신규 기능 카드</div>
                            </div>
                            <p class="tmpl-desc">썸네일 + 3줄 요약 + 자세히 보기. 릴리즈 안내/가이드에 적합.</p>
                            <div class="tmpl-meta">
                                <span class="badge">홈</span>
                                <span class="badge">대시보드</span>
                                <span class="badge">CTA</span>
                            </div>
                            <div class="tmpl-actions">
                                <button class="btn ghost" data-action="create">템플릿 생성</button>
                                <button class="btn" data-action="preview">
                  <i class="fa-regular fa-eye"></i>
                  미리보기
                </button>
                            </div>
                        </article>

                        <!-- 주간 통계 하이라이트 -->
                        <article class="tmpl-card" data-template-id="weekly">
                            <div class="tmpl-head">
                                <div class="tmpl-icon"><i class="fa-solid fa-chart-line"></i></div>
                                <div class="tmpl-title">주간 통계 하이라이트</div>
                            </div>
                            <p class="tmpl-desc">핵심 지표 3개 + 차트 이미지 스냅샷 + 요약 포인트. 자동 갱신 가능한 대시보드 링크.</p>
                            <div class="tmpl-meta">
                                <span class="badge">통계</span>
                                <span class="badge">요약</span>
                                <span class="badge">리포트</span>
                            </div>
                            <div class="tmpl-actions">
                                <button class="btn ghost" data-action="create">템플릿 생성</button>
                                <button class="btn" data-action="preview">
                  <i class="fa-regular fa-eye"></i>
                  미리보기
                </button>
                            </div>
                        </article>

                        <!-- 안전 수칙 카드 -->
                        <article class="tmpl-card" data-template-id="safety">
                            <div class="tmpl-head">
                                <div class="tmpl-icon"><i class="fa-solid fa-shield-heart"></i></div>
                                <div class="tmpl-title">안전 수칙 카드</div>
                            </div>
                            <p class="tmpl-desc">아이콘 + 한 줄 지침 + 자세히 보기. 야간 이동/분실물 등 접근성 ALT 카테고리 태그.</p>
                            <div class="tmpl-meta">
                                <span class="badge">안전</span>
                                <span class="badge">가이드</span>
                            </div>
                            <div class="tmpl-actions">
                                <button class="btn ghost" data-action="create">템플릿 생성</button>
                                <button class="btn" data-action="preview">
                  <i class="fa-regular fa-eye"></i>
                  미리보기
                </button>
                            </div>
                        </article>

                        <!-- 이벤트 안내 -->
                        <article class="tmpl-card" data-template-id="event">
                            <div class="tmpl-head">
                                <div class="tmpl-icon"><i class="fa-solid fa-calendar-check"></i></div>
                                <div class="tmpl-title">이벤트 안내</div>
                            </div>
                            <p class="tmpl-desc">일시/장소/신청 버튼. 설문·간담회·웨비나 공지에 활용. 예약 게시 외부 폼 연동.</p>
                            <div class="tmpl-meta">
                                <span class="badge">이벤트</span>
                                <span class="badge">폼 연동</span>
                            </div>
                            <div class="tmpl-actions">
                                <button class="btn ghost" data-action="create">템플릿 생성</button>
                                <button class="btn" data-action="preview">
                  <i class="fa-regular fa-eye"></i>
                  미리보기
                </button>
                            </div>
                        </article>

                        <!-- 앱 배너 공지 (신규) -->
                        <article class="tmpl-card" data-template-id="app-banner">
                            <div class="tmpl-head">
                                <div class="tmpl-icon"><i class="fa-solid fa-bullhorn"></i></div>
                                <div class="tmpl-title">앱 배너 공지</div>
                            </div>
                            <p class="tmpl-desc">앱 홈 상단 노란 배너 영역에 즉시 노출되는 공지를 생성합니다. (선택) CTA 링크 포함.</p>
                            <div class="tmpl-meta">
                                <span class="badge">앱 배너</span>
                                <span class="badge">공지</span>
                                <span class="badge">즉시 노출</span>
                            </div>
                            <div class="tmpl-actions">
                                <button class="btn ghost" data-action="banner">
                  <i class="fa-regular fa-paper-plane"></i>
                  앱에 띄우기
                </button>
                                <button class="btn" data-action="preview">
                  <i class="fa-regular fa-eye"></i>
                  미리보기
                </button>
                            </div>
                        </article>
                    </div>

                    <!-- 섹션: 최근 생성 (예시) -->
                    <h2 class="sec-title">
                        <i class="fa-solid fa-clock-rotate-left"></i> 최근 생성
                    </h2>
                    <div class="recent-wrap">
                        <div class="recent-item">
                            <span class="dot dot-on"></span>
                            <div class="recent-text">
                                <div class="title">가을 캠페인 배너</div>
                                <div class="meta">게시중 · 2025-09-10</div>
                            </div>
                            <button class="btn" onclick="location.href='/dashboard/contents/edit/123/'">열기</button>
                        </div>
                        <div class="recent-item">
                            <span class="dot dot-draft"></span>
                            <div class="recent-text">
                                <div class="title">홈 뉴스 카드 #12</div>
                                <div class="meta">임시저장 · 2025-09-08</div>
                            </div>
                            <button class="btn" onclick="location.href='/dashboard/contents/edit/124/'">계속 편집</button>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- 미리보기 모달 -->
    <div id="tmpl-modal-mask" style="
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        z-index: 9999;
        align-items: center;
        justify-content: center;
      ">
        <div id="tmpl-modal" style="
          width: min(920px, 90vw);
          max-height: 86vh;
          background: #fff;
          border-radius: 14px;
          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.18);
          display: flex;
          flex-direction: column;
        ">
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid #eee">
                <strong id="tmpl-modal-title" style="font-size: 16px">미리보기</strong>
                <button id="tmpl-modal-close" style="height: 32px; padding: 0 10px; border: 1px solid #e5e7eb; border-radius: 8px; background: #fff; cursor: pointer">
          닫기
        </button>
            </div>
            <div style="padding: 0; overflow: auto; flex: 1; min-height: 360px">
                <iframe id="tmpl-modal-frame" src="" style="width: 100%; height: 65vh; border: 0; display: none"></iframe>
                <img id="tmpl-modal-img" src="" alt="" style="max-width: 100%; display: none" />
                <div id="tmpl-modal-body" style="padding: 16px; display: none"></div>
            </div>
            <div style="padding: 12px 16px; border-top: 1px solid #eee; display: flex; gap: 8px; justify-content: flex-end">
                <button id="tmpl-modal-use" style="
              height: 36px;
              padding: 0 12px;
              border: 1px solid #111827;
              background: #111827;
              color: #fff;
              border-radius: 10px;
              cursor: pointer;
            ">
          이 템플릿으로 만들기
        </button>
            </div>
        </div>
    </div>

    <!-- 앱 배너 생성 모달 (신규) -->
    <div id="banner-modal-mask" style="
        display:none; position:fixed; inset:0; background:rgba(0,0,0,.45);
        z-index:10000; align-items:center; justify-content:center;">
        <div style="width:min(720px,92vw); background:#fff; border-radius:14px; box-shadow:0 10px 40px rgba(0,0,0,0.18);">
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #eee;">
                <strong style="font-size:16px">앱 배너 공지 만들기</strong>
                <button id="banner-modal-close" style="height:32px; padding:0 10px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; cursor:pointer">닫기</button>
            </div>
            <div style="padding:16px; display:grid; gap:12px;">
                <label style="display:grid; gap:6px;">
          <span>텍스트 <span style="color:#d00">*</span></span>
          <textarea id="banner-text" rows="3" class="input" placeholder="앱 상단에 표시될 공지 문구를 입력하세요" style="width:100%;"></textarea>
        </label>
                <label style="display:grid; gap:6px;">
          <span>CTA URL (선택)</span>
          <input id="banner-cta" type="url" class="input" placeholder="https:// 또는 앱 내 딥링크" />
        </label>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <label style="display:grid; gap:6px;">
            <span>시작 시각 (기본: 지금)</span>
            <input id="banner-starts" type="datetime-local" class="input" />
          </label>
                    <label style="display:grid; gap:6px;">
            <span>종료 시각 (선택)</span>
            <input id="banner-ends" type="datetime-local" class="input" />
          </label>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <label style="display:grid; gap:6px;">
            <span>우선순위</span>
            <input id="banner-priority" type="number" class="input" value="0" />
          </label>
                    <label style="display:flex; align-items:center; gap:10px; margin-top:26px;">
            <input id="banner-active" type="checkbox" checked />
            <span>활성화 (체크 시 바로 노출)</span>
          </label>
                </div>
            </div>
            <div style="padding:12px 16px; border-top:1px solid #eee; display:flex; gap:8px; justify-content:flex-end;">
                <button id="banner-submit" class="btn primary"><i class="fa-regular fa-paper-plane"></i> 생성 및 앱에 띄우기</button>
            </div>
        </div>
    </div>

    <!-- 동작 스크립트 -->
    <script>
        (function() {
            // -------- 라우트(필요시 수정) --------
            const URLS = {
                newFromTemplate: (tid) => '/dashboard/contents/new/?template=' + encodeURIComponent(tid),
                previewTemplate: (tid) => '/dashboard/contents/preview/?template=' + encodeURIComponent(tid),
                addTemplate: '/dashboard/contents/templates/new/',
                newContent: '/dashboard/contents/new/',
                apiCreate: '/dashboard/api/contents/create/', // 있으면 사용, 없으면 자동 폴백
                apiBannerCreate: '/api/app-banners/', // 앱 배너 생성 (DRF ViewSet)
            };

            // -------- DOM --------
            const grid = document.querySelector('.template-grid, .tmpl-grid, .cards-grid, .cards3');
            const q = document.getElementById('q');
            const btnSearch = document.getElementById('btn-search');
            const btnNew = document.getElementById('btn-new');
            const btnAddTmpl = document.getElementById('btn-add-template');
            const sel = document.getElementById('templateSelect');

            // 미리보기 모달
            const $mask = document.getElementById('tmpl-modal-mask');
            const $title = document.getElementById('tmpl-modal-title');
            const $frame = document.getElementById('tmpl-modal-frame');
            const $img = document.getElementById('tmpl-modal-img');
            const $body = document.getElementById('tmpl-modal-body');
            const $close = document.getElementById('tmpl-modal-close');
            const $use = document.getElementById('tmpl-modal-use');
            let currentTid = null;

            // 배너 모달
            const $bMask = document.getElementById('banner-modal-mask');
            const $bClose = document.getElementById('banner-modal-close');
            const $bText = document.getElementById('banner-text');
            const $bCta = document.getElementById('banner-cta');
            const $bStarts = document.getElementById('banner-starts');
            const $bEnds = document.getElementById('banner-ends');
            const $bPrio = document.getElementById('banner-priority');
            const $bActive = document.getElementById('banner-active');
            const $bSubmit = document.getElementById('banner-submit');

            // -------- 유틸 --------
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }

            function openModal(opts) {
                currentTid = opts.tid || null;
                $title.textContent = opts.title || '미리보기';
                if (opts.iframe) {
                    $frame.src = opts.iframe;
                    $frame.style.display = 'block';
                    $img.style.display = 'none';
                    $body.style.display = 'none';
                } else if (opts.image) {
                    $img.src = opts.image;
                    $img.style.display = 'block';
                    $frame.style.display = 'none';
                    $body.style.display = 'none';
                } else {
                    $body.innerHTML = opts.html || '<p>미리볼 내용이 없습니다.</p>';
                    $body.style.display = 'block';
                    $frame.style.display = 'none';
                    $img.style.display = 'none';
                }
                $mask.style.display = 'flex';
            }

            function closeModal() {
                $mask.style.display = 'none';
                $frame.src = '';
                currentTid = null;
            }
            $close.addEventListener('click', closeModal);
            $mask.addEventListener('click', (e) => {
                if (e.target === $mask) closeModal();
            });
            $use.addEventListener('click', function() {
                if (!currentTid) return closeModal();
                location.href = URLS.newFromTemplate(currentTid);
            });

            function openBannerModal() {
                // 기본값 세팅: starts_at = 지금(로컬)
                try {
                    const now = new Date();
                    const pad = (n) => String(n).padStart(2, '0');
                    const local = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
                    $bStarts.value = local;
                } catch {}
                $bText.value = '';
                $bCta.value = '';
                $bEnds.value = '';
                $bPrio.value = '0';
                $bActive.checked = true;

                $bMask.style.display = 'flex';
            }

            function closeBannerModal() {
                $bMask.style.display = 'none';
            }
            $bClose.addEventListener('click', closeBannerModal);
            $bMask.addEventListener('click', (e) => {
                if (e.target === $bMask) closeBannerModal();
            });

            async function submitBanner() {
                const text = ($bText.value || '').trim();
                if (!text) {
                    alert('텍스트는 필수입니다.');
                    return;
                }

                const cta_url = ($bCta.value || '').trim();
                const starts_at_local = ($bStarts.value || '').trim(); // datetime-local (로컬)
                const ends_at_local = ($bEnds.value || '').trim();
                const priority = Number($bPrio.value || 0);
                const is_active = !!$bActive.checked;

                // 로컬 datetime → ISO(UTC) 변환
                function toIsoOrNull(dtLocal) {
                    if (!dtLocal) return null;
                    const d = new Date(dtLocal);
                    const iso = new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString(); // Z기준
                    return iso;
                }

                const payload = {
                    text,
                    cta_url,
                    starts_at: starts_at_local ? toIsoOrNull(starts_at_local) : null, // 백엔드에서 null은 "즉시"로 처리 가능
                    ends_at: ends_at_local ? toIsoOrNull(ends_at_local) : null,
                    priority,
                    is_active
                };

                const csrftoken = getCookie('csrftoken');
                try {
                    const res = await fetch(URLS.apiBannerCreate, {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken || ''
                        },
                        body: JSON.stringify(payload)
                    });

                    if (res.ok) {
                        alert('앱 배너 공지가 생성되었습니다. (활성 시 즉시 노출)');
                        closeBannerModal();
                    } else {
                        const txt = await res.text();
                        console.warn('banner create non-OK:', res.status, txt);
                        alert('생성에 실패했습니다. (' + res.status + ')');
                    }
                } catch (e) {
                    console.error('banner create error', e);
                    alert('네트워크 오류로 실패했습니다.');
                }
            }
            document.getElementById('banner-submit').addEventListener('click', submitBanner);

            // -------- 동작 --------
            async function createFromTemplate(tid) {
                // API 있으면 시도 → 실패해도 폴백 이동
                try {
                    const res = await fetch(URLS.apiCreate, {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            template_id: tid
                        }),
                    });
                    if (res.ok) {
                        const d = await res.json();
                        if (d && d.edit_url) {
                            location.href = d.edit_url;
                            return;
                        }
                    }
                } catch (e) {}
                location.href = URLS.newFromTemplate(tid);
            }

            function previewTemplate(tid, title) {
                openModal({
                    tid,
                    title: title || '미리보기',
                    iframe: URLS.previewTemplate(tid)
                });
            }

            // 카드 클릭 위임
            if (grid) {
                grid.addEventListener('click', function(e) {
                    const btn = e.target.closest('button, a');
                    if (!btn) return;

                    let action = btn.getAttribute('data-action');
                    const label = (btn.textContent || '').trim();
                    if (!action) {
                        if (/미리보기/.test(label)) action = 'preview';
                        else if (/생성|만들기/.test(label)) action = 'create';
                        else if (/앱에 띄우기/.test(label)) action = 'banner';
                    }

                    const card = btn.closest('[data-template-id]');
                    const tid = card && card.getAttribute('data-template-id');
                    const titleEl = card && (card.querySelector('.tmpl-title') || card.querySelector('h3, h4'));
                    const ttitle = titleEl ? (titleEl.textContent || '').trim() : '템플릿';

                    if (!tid || !action) return;

                    e.preventDefault();
                    if (action === 'create') createFromTemplate(tid);
                    if (action === 'preview') previewTemplate(tid, ttitle);
                    if (action === 'banner') openBannerModal();
                });
            }

            // 상단 버튼
            if (btnSearch) btnSearch.addEventListener('click', function() {
                const key = ((q && q.value) || '').trim();
                if (!key) return;
                location.href = '/dashboard/contents/?q=' + encodeURIComponent(key);
            });
            if (btnNew) btnNew.addEventListener('click', function() {
                const v = sel && sel.value ? '?template=' + encodeURIComponent(sel.value) : '';
                location.href = URLS.newContent + v;
            });
            if (btnAddTmpl) btnAddTmpl.addEventListener('click', function() {
                location.href = URLS.addTemplate;
            });

            // 접근성: 카드 타이틀 클릭 → 미리보기
            document.querySelectorAll('[data-template-id] .tmpl-title').forEach(function(el) {
                el.style.cursor = 'pointer';
                el.addEventListener('click', function() {
                    const card = el.closest('[data-template-id]');
                    const tid = card && card.getAttribute('data-template-id');
                    if (tid) previewTemplate(tid, (el.textContent || '').trim());
                });
            });
        })();
    </script>
</body>

</html>