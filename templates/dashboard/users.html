{% load static %}
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>관리자 페이지 | 사용자 관리</title>

    <link rel="icon" href="{% static 'dashboard/images/favicon.ico' %}" sizes="any" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}?v=fit-2025-11-02" />
    <link rel="stylesheet" href="{% static 'dashboard/css/users.css' %}?v=2025-11-02" />
  </head>

  <body class="page-users">
    <div class="container">
      <!-- 사이드바 -->
      <aside class="sidebar">
        <div class="sidebar-brand">관리자 페이지</div>
        <div class="sidebar-logo">
          <img src="{% static 'dashboard/images/logo.png' %}" alt="SENCITY" />
          <span>SENCITY</span>
        </div>
        <a href="{% url 'admin:index' %}" class="sidebar-link">
          <i class="fa-solid fa-arrow-up-right-from-square"></i>
          사이트 바로가기
        </a>
        <hr />
        <nav class="sidebar-menu">
          <div class="menu-group">사이트 관리</div>
          <a href="{% url 'dashboard:home' %}" class="menu-item">
            <i class="fa-solid fa-th-large"></i>
            대시보드
          </a>
          <a href="{% url 'dashboard:cctv' %}" class="menu-item">
            <i class="fa-solid fa-camera"></i>
            CCTV 관리
          </a>
          <a href="{% url 'dashboard:reports' %}" class="menu-item">
            <i class="fa-solid fa-tv"></i>
            신고 처리 및 관리
          </a>
          <a href="{% url 'dashboard:settings' %}" class="menu-item">
            <i class="fa-solid fa-gear"></i>
            설정
          </a>
          <a href="{% url 'dashboard:users' %}" class="menu-item active">
            <i class="fa-solid fa-user"></i>
            사용자 관리
          </a>

          <div class="menu-group">콘텐츠 및 통계</div>
          <a href="{% url 'dashboard:analytics' %}" class="menu-item">
            <i class="fa-solid fa-chart-column"></i>
            데이터 분석 및 통계
          </a>
          <a href="{% url 'dashboard:contents' %}" class="menu-item">
            <i class="fa-solid fa-file-lines"></i>
            콘텐츠 관리
          </a>
          <a href="{% url 'dashboard:notices' %}" class="menu-item">
            <i class="fa-solid fa-bell"></i>
            공지 설정
          </a>
        </nav>
      </aside>

      <!-- 본문 -->
      <main class="main">
        <div class="main-content">
          <div class="dashboard-body wrap">
            <h1 class="page-title">사용자 관리</h1>

            <section class="card">
              <div class="toolbar">
                <input id="q" placeholder="이름/이메일 검색" />
                <button id="search">검색</button>
              </div>
              <div class="table-wrap">
                <div id="user-list"></div>
              </div>
            </section>
          </div>
        </div>
      </main>

      <!-- 우측 드로어 -->
      <aside id="drawer" class="drawer" aria-hidden="true">
        <header class="drawer-header">
          <div class="avatar"><i class="fa-regular fa-user"></i></div>
          <div class="info">
            <div class="name" id="dvName">-</div>
            <div class="email" id="dvEmail">-</div>
          </div>
          <div class="ops">
            <span id="badgeActive" class="chip success" style="display: none">활성</span>
            <span id="badgeInactive" class="chip muted" style="display: none">비활성</span>
            <button id="btnClose" class="btn icon" title="닫기"><i class="fa-solid fa-xmark"></i></button>
          </div>
        </header>

        <!-- 탭 -->
        <nav class="tabs">
          <button class="tab active" data-tab="overview">개요</button>
          <button class="tab" data-tab="activity">활동</button>
          <button class="tab" data-tab="security">보안</button>
        </nav>

        <!-- 개요 -->
        <section id="tab-overview" class="tabpanel" role="tabpanel">
          <div class="kpi-row">
            <div class="kpi-card" data-skel id="kpiTotal">
              <div class="kpi-title">총 신고</div>
              <div class="kpi-value" id="valTotal">-</div>
              <div class="kpi-sub">전체 신고 누계</div>
            </div>
            <div class="kpi-card" data-skel id="kpiLast30">
              <div class="kpi-title">최근 30일 신고</div>
              <div class="kpi-value" id="valLast30">-</div>
              <div class="kpi-sub">최근 30일</div>
            </div>
            <div class="kpi-card" data-skel id="kpiSessions">
              <div class="kpi-title">활성 세션</div>
              <div class="kpi-value" id="valSessions">-</div>
              <div class="kpi-sub">현재 로그인 수</div>
            </div>
          </div>

          <div class="grid2">
            <div class="card soft" data-skel>
              <h3>프로필</h3>
              <div class="kv">
                <div>
                  <span>가입일</span>
                  <em id="dvJoined">-</em>
                </div>
                <div>
                  <span>최근 로그인</span>
                  <em id="dvLastLogin">-</em>
                </div>
                <div>
                  <span>그룹</span>
                  <em id="dvGroups">-</em>
                </div>
              </div>
            </div>
            <div class="card soft" data-skel>
              <h3>이메일 인증</h3>
              <div class="kv">
                <div>
                  <span>상태</span>
                  <em id="dvEmailVerified">-</em>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- 활동 -->
        <section id="tab-activity" class="tabpanel" role="tabpanel" aria-hidden="true">
          <div class="grid2">
            <div class="card soft" data-skel>
              <h3>동물 Top3</h3>
              <ul class="kvlist" id="dvAnimalTop"></ul>
            </div>
            <div class="card soft" data-skel>
              <h3>지역 Top3</h3>
              <ul class="kvlist" id="dvRegionTop"></ul>
            </div>
          </div>
          <div class="card soft" data-skel>
            <h3>최근 신고 5건</h3>
            <div id="dvRecent"></div>
          </div>
        </section>

        <!-- 보안 -->
        <section id="tab-security" class="tabpanel" role="tabpanel" aria-hidden="true">
          <div class="card soft" data-skel>
            <h3>로그인 기록</h3>
            <div id="dvLoginLogs" class="muted">로그인 기록 없음</div>
          </div>
          <div class="card soft" data-skel>
            <h3>세션</h3>
            <div>
              활성 세션:
              <b id="dvActSessions">0</b>
            </div>
          </div>
        </section>
      </aside>
    </div>

    <script>
      /* ===== API ===== */
      const API_USERS = '/dashboard/api/users/';
      const API_USER_DETAIL = (id) => `/dashboard/api/users/${id}/`;

      /* ===== 유틸 ===== */
      const $ = (s, r = document) => r.querySelector(s);
      const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
      const htmlEscape = (s = '') =>
        s.replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
      const showSkel = (on) => $$('.drawer [data-skel]').forEach((el) => el.classList.toggle('loading', !!on));

      /* ===== 리스트 ===== */
      const els = {
        list: () => document.getElementById('user-list'),
        q: () => document.getElementById('q'),
        btn: () => document.getElementById('search'),
      };

      function renderTable(d) {
        const rows = (d.results || [])
          .map(
            (r) => `
      <tr data-id="${r.id}">
        <td style="width:8ch">${r.id}</td>
        <td>${htmlEscape(r.name || '')}</td>
        <td class="ellipsis">${htmlEscape(r.email || '')}</td>
        <td style="width:14ch">${htmlEscape(r.role || '')}</td>
        <td style="width:18ch">${htmlEscape(r.joined || '')}</td>
      </tr>
    `
          )
          .join('');

        els.list().innerHTML = `
      <table class="table users">
        <thead>
          <tr>
            <th style="width:8ch">ID</th>
            <th style="width:18ch">이름</th>
            <th>이메일</th>
            <th style="width:14ch">권한</th>
            <th style="width:18ch">가입일</th>
          </tr>
        </thead>
        <tbody>${rows || `<tr><td colspan="5" class="empty">데이터가 없습니다</td></tr>`}</tbody>
      </table>
    `;

        $$('.table.users tbody tr').forEach((tr) => {
          tr.addEventListener('click', () => openDrawer(Number(tr.dataset.id)));
        });
      }

      async function loadUsers(page = 1, q = '') {
        els.list().innerHTML = `<div style="padding:12px;color:#6b7280;">불러오는 중…</div>`;
        const url = new URL(API_USERS, window.location.origin);
        url.searchParams.set('page', page);
        url.searchParams.set('page_size', 20);
        if (q) url.searchParams.set('q', q);
        const r = await fetch(url, { credentials: 'same-origin' });
        if (!r.ok) {
          els.list().innerHTML = `<div style="padding:12px;color:#b91c1c;">불러오기에 실패했습니다.</div>`;
          return;
        }
        renderTable(await r.json());
      }

      /* ===== 상세(드로어) ===== */
      let currentId = null;

      function switchTab(key) {
        $$('.tabs .tab').forEach((b) => b.classList.toggle('active', b.dataset.tab === key));
        $('#tab-overview').setAttribute('aria-hidden', String(key !== 'overview'));
        $('#tab-activity').setAttribute('aria-hidden', String(key !== 'activity'));
        $('#tab-security').setAttribute('aria-hidden', String(key !== 'security'));
      }

      function renderKVList(el, arr) {
        if (!arr || !arr.length) {
          el.innerHTML = `<div class="empty">데이터 없음</div>`;
          return;
        }
        el.innerHTML = arr.map(([k, v]) => `<li><span>${htmlEscape(k || '-')}</span><em>${v}</em></li>`).join('');
      }

      function fillDrawer(d) {
        const u = d.user || {};
        const s = d.stats || {};
        const ev = d.email_verification || {};
        const act = d.activity || {};
        const lg = d.logins || {};

        // ── 숫자 안전 파서: 첫 번째로 숫자화 가능한 값을 선택
        const num = (...vals) => {
          for (const v of vals) {
            const n = Number(v);
            if (!Number.isNaN(n)) return n;
          }
          return 0;
        };

        // 헤더
        document.getElementById('dvName').textContent = u.name || '-';
        document.getElementById('dvEmail').textContent = u.email || '-';
        const active = !!u.is_active;
        document.getElementById('badgeActive').style.display = active ? 'inline-flex' : 'none';
        document.getElementById('badgeInactive').style.display = active ? 'none' : 'inline-flex';

        // ✅ KPI (키 후보를 모두 고려)
        const total = num(s.total_reports, s.total, act.total_reports, u.total_reports);
        const last30 = num(s.last30_reports, s.recent_30d, s.last30, act.recent_30d);
        const sessions = num(s.active_sessions, lg.act_sessions, lg.active_sessions);

        document.getElementById('valTotal').textContent = total;
        document.getElementById('valLast30').textContent = last30;
        document.getElementById('valSessions').textContent = sessions;
        document.getElementById('dvActSessions').textContent = sessions;

        // 프로필
        document.getElementById('dvJoined').textContent = u.date_joined || '-';
        document.getElementById('dvLastLogin').textContent = u.last_login ? u.last_login.replace('T', ' ').slice(0, 16) : '-';
        document.getElementById('dvGroups').textContent = u.groups && u.groups.length ? u.groups.join(', ') : '-';

        // 이메일 인증
        document.getElementById('dvEmailVerified').textContent = ev.verified ? '인증됨' : '미인증';

        // 활동
        // 활동
        const normalizePairs = (src) => {
          // 배열 형태 [["고라니", 3], ...] 이면 그대로
          if (Array.isArray(src)) return src;

          // 객체 형태 { "고라니": 3, "멧돼지": 2 } 이면 entries 로 변환
          if (src && typeof src === 'object') {
            return Object.entries(src);
          }
          return [];
        };

        const renderKVList = (el, arr) => {
          if (!arr || !arr.length) {
            el.innerHTML = `<div class="empty">데이터 없음</div>`;
            return;
          }
          el.innerHTML = arr.map(([k, v]) => `<li><span>${htmlEscape(k || '-')}</span><em>${v}</em></li>`).join('');
        };

        // 동물 Top3: 여러 후보 키 중 먼저 존재하는 것 사용
        const animalTop = normalizePairs(act.by_animal_top || act.by_animal || act.animals_top || act.animal_top);

        // 지역 Top3: 여러 후보 키 중 먼저 존재하는 것 사용
        const regionTop = normalizePairs(act.by_region_top || act.by_region || act.regions_top || act.region_top);

        renderKVList(document.getElementById('dvAnimalTop'), animalTop);
        renderKVList(document.getElementById('dvRegionTop'), regionTop);

        const recent = act.recent || act.recent_reports || [];
        document.getElementById('dvRecent').innerHTML = recent.length
          ? recent
              .map(
                (r) => `
        <div class="recent">
          <div class="title mono">#${r.id} · ${r.title || '(제목 없음)'}</div>
          <div class="meta">
            <span>${r.animal || '미상'}</span>
            · <span class="muted">${r.status || ''}</span>
            · <span class="muted">${r.datetime ? r.datetime.replace('T', ' ').slice(0, 16) : r.date || ''}</span>
          </div>
          <div class="muted">${r.region || ''}</div>
        </div>
      `
              )
              .join('')
          : `<div class="empty">최근 신고 없음</div>`;

        // 로딩 해제
        showSkel(false);
      }

      async function openDrawer(id) {
        currentId = id;
        const dr = document.getElementById('drawer');
        dr.classList.add('open');
        dr.setAttribute('aria-hidden', 'false');
        switchTab('overview');

        // 초기 스켈레톤 ON
        showSkel(true);

        try {
          const r = await fetch(API_USER_DETAIL(id), { credentials: 'same-origin' });
          if (!r.ok) throw new Error('상세 실패');
          const d = await r.json();
          fillDrawer(d);
        } catch (e) {
          alert('상세를 불러오지 못했습니다.');
          showSkel(false);
        }
      }

      function closeDrawer() {
        const dr = document.getElementById('drawer');
        dr.classList.remove('open');
        dr.setAttribute('aria-hidden', 'true');
      }

      /* ===== 초기 바인딩 ===== */
      document.addEventListener('DOMContentLoaded', () => {
        // 검색
        let t;
        els.q().addEventListener('input', () => {
          clearTimeout(t);
          t = setTimeout(() => loadUsers(1, els.q().value.trim()), 300);
        });
        els.btn().addEventListener('click', () => loadUsers(1, els.q().value.trim()));
        loadUsers(1, '');

        // 탭
        $$('.tabs .tab').forEach((b) => b.addEventListener('click', () => switchTab(b.dataset.tab)));
        // 닫기
        document.getElementById('btnClose').addEventListener('click', closeDrawer);
      });
    </script>
  </body>
</html>
