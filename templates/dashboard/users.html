{% load static %}
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>관리자 페이지 | 사용자 관리</title>

    <link rel="icon" href="{% static 'dashboard/images/favicon.ico' %}" sizes="any" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}?v=fit-2025-09-19" />

    <link rel="stylesheet" href="{% static 'dashboard/css/users.css' %}?v=2025-09-19" />
</head>

<body class="page-users">
    <div class="container">
        <!-- 사이드바 -->
        <aside class="sidebar">
            <div class="sidebar-brand">관리자 페이지</div>
            <div class="sidebar-logo">
                <img src="{% static 'dashboard/images/logo.png' %}" alt="SENCITY" />
                <span>SENCITY</span>
            </div>
            <a href="{% url 'admin:index' %}" class="sidebar-link">
                <i class="fa-solid fa-arrow-up-right-from-square"></i> 사이트 바로가기
            </a>
            <hr />
            <nav class="sidebar-menu">
                <div class="menu-group">사이트 관리</div>
                <a href="{% url 'dashboard:home' %}" class="menu-item">
                    <i class="fa-solid fa-th-large"></i> 대시보드
                </a>
                <a href="{% url 'dashboard:cctv' %}" class="menu-item">
                    <i class="fa-solid fa-camera"></i> CCTV 관리
                </a>
                <a href="{% url 'dashboard:reports' %}" class="menu-item">
                    <i class="fa-solid fa-tv"></i> 신고 처리 및 관리
                </a>
                <a href="{% url 'dashboard:settings' %}" class="menu-item">
                    <i class="fa-solid fa-gear"></i> 설정
                </a>
                <a href="{% url 'dashboard:users' %}" class="menu-item active">
                    <i class="fa-solid fa-user"></i> 사용자 관리
                </a>

                <div class="menu-group">콘텐츠 및 통계</div>
                <a href="{% url 'dashboard:analytics' %}" class="menu-item">
                    <i class="fa-solid fa-chart-column"></i> 데이터 분석 및 통계
                </a>
                <a href="{% url 'dashboard:contents' %}" class="menu-item">
                    <i class="fa-solid fa-file-lines"></i> 콘텐츠 관리
                </a>
                <a href="{% url 'dashboard:notices' %}" class="menu-item">
                    <i class="fa-solid fa-bell"></i> 공지 설정
                </a>
            </nav>
        </aside>

        <!-- 본문 -->
        <main class="main">
            <div class="main-content">
                <div class="dashboard-body wrap">
                    <h1 class="page-title">사용자 관리</h1>

                    <section class="card">
                        <div class="toolbar">
                            <input id="q" placeholder="이름/이메일 검색" />
                            <button id="search">검색</button>
                        </div>
                        <div class="table-wrap">
                            <div id="user-list"></div>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <script>
        /* ===== API 엔드포인트 ===== */
        const API_USERS = '/dashboard/api/users/';

        /* ===== 엘리먼트 ===== */
        const els = {
            list: () => document.getElementById('user-list'),
            q: () => document.getElementById('q'),
            btn: () => document.getElementById('search'),
        };

        /* ===== 유틸 ===== */
        function htmlEscape(s = '') {
            return s.replace(
                /[&<>"']/g,
                (m) =>
                ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;',
                }[m])
            );
        }

        /* ===== 렌더링 ===== */
        function renderTable(d) {
            const rows = (d.results || [])
                .map(
                    (r) => `
          <tr>
            <td>${r.id}</td>
            <td>${htmlEscape(r.name || '')}</td>
            <td>${htmlEscape(r.email || '')}</td>
            <td>${htmlEscape(r.role || '')}</td>
            <td>${htmlEscape(r.joined || '')}</td>
          </tr>
        `
                )
                .join('');

            const pager =
                d.total_pages > 1 ?
                `
          <div class="pager">
            <button data-pg="${Math.max(1, (d.page || 1) - 1)}" ${d.page <= 1 ? 'disabled' : ''}>이전</button>
            <span>${d.page} / ${d.total_pages}</span>
            <button data-pg="${Math.min(d.total_pages, (d.page || 1) + 1)}" ${d.page >= d.total_pages ? 'disabled' : ''}>다음</button>
          </div>
        ` :
                '';

            els.list().innerHTML = `
          <table class="table">
            <thead>
              <tr>
                <th style="width:8ch">ID</th>
                <th style="width:18ch">이름</th>
                <th>이메일</th>
                <th style="width:14ch">권한</th>
                <th style="width:18ch">가입일</th>
              </tr>
            </thead>
            <tbody>
              ${rows || `<tr><td colspan="5" class="empty">데이터가 없습니다</td></tr>`}
            </tbody>
          </table>
          ${pager}
        `;

        // 페이징 클릭
        els
          .list()
          .querySelectorAll('button[data-pg]')
          .forEach((b) => {
            b.addEventListener('click', () => {
              const p = Number(b.getAttribute('data-pg'));
              loadUsers(p, els.q().value.trim());
            });
          });
      }

      /* ===== 데이터 로드 ===== */
      async function loadUsers(page = 1, q = '') {
        els.list().innerHTML = `<div style="padding:12px;color:#6b7280;">불러오는 중…</div>`;
        const url = new URL(API_USERS, window.location.origin);
        url.searchParams.set('page', page);
        url.searchParams.set('page_size', 20);
        if (q) url.searchParams.set('q', q);

        const r = await fetch(url, { credentials: 'same-origin' });
        if (!r.ok) {
          els.list().innerHTML = `<div style="padding:12px;color:#b91c1c;">불러오기에 실패했습니다.</div>`;
          return;
        }
        const d = await r.json();
        renderTable(d);
      }

      /* ===== 검색 ===== */
      let timer;
      document.addEventListener('DOMContentLoaded', () => {
        els.q().addEventListener('input', () => {
          clearTimeout(timer);
          timer = setTimeout(() => loadUsers(1, els.q().value.trim()), 300);
        });
        els.btn().addEventListener('click', () => loadUsers(1, els.q().value.trim()));
        loadUsers(1, '');
      });
    </script>
</body>

</html>
